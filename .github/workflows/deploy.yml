name: Build & Deploy .NET App to Windows VM via WinRM HTTPS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load environment variables
        run: |
          Get-Content .env | ForEach-Object {
            if ($_ -match '^\s*$') { return }
            $name, $value = $_ -split '=', 2
            echo "$name=$value" >> $env:GITHUB_ENV
          }

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Build and Publish
        run: |
          dotnet restore Manatalol/Manatalol.App/Manatalol.App.csproj
          dotnet build Manatalol/Manatalol.App/Manatalol.App.csproj --configuration Release --no-restore
          dotnet publish Manatalol/Manatalol.App/Manatalol.App.csproj -c Release -o ./output/published

      - name: Verify published output
        run: |
          if (-Not (Test-Path "./output/published")) {
            Write-Host "‚ùå Le dossier ./output/published est introuvable."
            exit 1
          } else {
            Write-Host "‚úÖ Dossier publi√© trouv√©."
          }

      - name: Package app
        run: Compress-Archive -Path ./output/published/* -DestinationPath Manatalol.zip -Force

      - name: Deploy & Restart service
        shell: pwsh
        run: |
          $vmHost = $env:VM_HOST
          $vmUser = $env:VM_USERNAME
          $vmPass = $env:VM_PASSWORD | ConvertTo-SecureString -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential ($vmUser, $vmPass)

          # Conserver HTTPS avec port 5986 et Ignorer le certificat auto-sign√©
          $session = New-PSSession -ComputerName $vmHost -Credential $cred -UseSSL -SessionOption (New-PSSessionOption -SkipCACheck -SkipCNCheck)

          Invoke-Command -Session $session -ScriptBlock {
              param($zipPath, $deployPath, $serviceName)

              Write-Host "üì¶ Copie et extraction du package..."
              Copy-Item -Path "C:\Users\runneradmin\actions-runner\_work\manatalol\manatalol\Manatalol.zip" -Destination "C:\temp\Manatalol.zip" -Force
              
              if (Test-Path $deployPath) { Remove-Item -Recurse -Force $deployPath }
              New-Item -ItemType Directory -Force -Path $deployPath | Out-Null
              Expand-Archive -Path "C:\temp\Manatalol.zip" -DestinationPath $deployPath -Force

              if (Get-Service -Name $serviceName -ErrorAction SilentlyContinue) {
                Write-Host "üîÑ Red√©marrage du service $serviceName..."
                Restart-Service -Name $serviceName -Force
              } else {
                Write-Host "‚ö†Ô∏è Service $serviceName introuvable, aucun red√©marrage effectu√©."
              }

              Write-Host "‚úÖ D√©ploiement termin√©."
          } -ArgumentList "C:\temp\Manatalol.zip", $env:DEPLOY_PATH, $env:SERVICE_NAME

          Remove-PSSession $session