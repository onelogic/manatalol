name: Build & Deploy .NET App to Windows VM via SSH

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load environment variables
        run: |
          if [ -f .env ]; then
            export $(grep -v '^#' .env | xargs)
          fi

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Build and Publish
        run: |
          dotnet restore Manatalol/Manatalol.App/Manatalol.App.csproj
          dotnet build Manatalol/Manatalol.App/Manatalol.App.csproj --configuration Release --no-restore
          dotnet publish Manatalol/Manatalol.App/Manatalol.App.csproj -c Release -o ./output/published

      - name: Verify published output
        run: |
          if [ ! -d "./output/published" ]; then
            echo "‚ùå Le dossier ./output/published est introuvable."
            exit 1
          fi
          echo "‚úÖ Dossier publi√© trouv√©."

      - name: Package app
        run: zip -r Manatalol.zip ./output/published

      - name: Upload package to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          password: ${{ secrets.VM_PASSWORD }}
          source: "Manatalol.zip"
          target: "C:/temp/Manatalol.zip"

      - name: Deploy & Restart service
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          password: ${{ secrets.VM_PASSWORD }}
          script_stop: true
          script: |
            Write-Host "üì¶ D√©ploiement sur la VM Windows..."
            $deployPath = "C:\inetpub\Manatalol"
            $zipPath = "C:\temp\Manatalol.zip"
            $serviceName = "ManatalolService"

            if (Test-Path $deployPath) { Remove-Item -Recurse -Force $deployPath }
            New-Item -ItemType Directory -Force -Path $deployPath | Out-Null

            Expand-Archive -Path $zipPath -DestinationPath $deployPath -Force
            Write-Host "‚úÖ Application d√©ploy√©e dans $deployPath"

            if (Get-Service -Name $serviceName -ErrorAction SilentlyContinue) {
              Write-Host "üîÑ Red√©marrage du service $serviceName..."
              Restart-Service -Name $serviceName -Force
            } else {
              Write-Host "‚ö†Ô∏è Service $serviceName introuvable, aucun red√©marrage effectu√©."
            }

            Write-Host "üöÄ D√©ploiement termin√© avec succ√®s."