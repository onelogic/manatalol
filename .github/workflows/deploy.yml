name: Build & Deploy .NET App to Windows VM (via SSH)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load environment variables
        run: |
          Get-Content .env | ForEach-Object {
            if ($_ -match '^\s*$') { return }
            $name, $value = $_ -split '=', 2
            echo "$name=$value" >> $env:GITHUB_ENV
          }

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.0

      - name: Build and Publish
        run: |
          dotnet restore Manatalol/Manatalol.App/Manatalol.App.csproj
          dotnet build Manatalol/Manatalol.App/Manatalol.App.csproj --configuration Release --no-restore
          dotnet publish Manatalol/Manatalol.App/Manatalol.App.csproj -c Release -o ./output/published

      - name: Verify published output
        run: |
          if (-Not (Test-Path "./output/published")) {
            Write-Host "‚ùå Le dossier ./output/published est introuvable."
            exit 1
          } else {
            Write-Host "‚úÖ Dossier publi√© trouv√©."
          }

      - name: Package app
        run: Compress-Archive -Path ./output/published/* -DestinationPath Manatalol.zip -Force

      - name: Upload package to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USERNAME }}
          password: ${{ env.VM_PASSWORD }}
          source: "Manatalol.zip"
          target: "C:/temp/Manatalol.zip"

      - name: Deploy & Restart service
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ env.VM_HOST }}
          username: ${{ env.VM_USERNAME }}
          password: ${{ env.VM_PASSWORD }}
          script: |
            $remoteZip = "C:\temp\Manatalol.zip"
            $deployPath = "${{ env.DEPLOY_PATH }}"
            $serviceName = "${{ env.SERVICE_NAME }}"

            Write-Host "üì¶ Extraction du package vers $deployPath..."
            if (Test-Path $deployPath) { Remove-Item -Recurse -Force $deployPath }
            New-Item -ItemType Directory -Force -Path $deployPath | Out-Null
            Expand-Archive -Path $remoteZip -DestinationPath $deployPath -Force

            if (Get-Service -Name $serviceName -ErrorAction SilentlyContinue) {
              Write-Host "üîÑ Red√©marrage du service $serviceName..."
              Restart-Service -Name $serviceName -Force
            } else {
              Write-Host "‚ö†Ô∏è Service $serviceName introuvable, aucun red√©marrage effectu√©."
            }

            Write-Host "‚úÖ D√©ploiement termin√© avec succ√®s."